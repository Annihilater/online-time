# Online Time Project Makefile
# ç®€åŒ–å¸¸ç”¨å¼€å‘æ“ä½œ

.PHONY: help install dev build test lint clean deploy status docker-build docker-run docker-stop docker-logs docker-clean docker-deploy compose-up compose-down docker-health

# é»˜è®¤ç›®æ ‡ - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "åœ¨çº¿é—¹é’Ÿé¡¹ç›® - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "  make install     å®‰è£…é¡¹ç›®ä¾èµ–"
	@echo "  make dev         å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
	@echo "  make build       æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
	@echo "  make test        è¿è¡Œæµ‹è¯•å¥—ä»¶"
	@echo "  make test-ui     å¯åŠ¨æµ‹è¯•UIç•Œé¢"
	@echo "  make lint        è¿è¡Œä»£ç æ£€æŸ¥"
	@echo "  make lint-fix    è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜"
	@echo "  make preview     é¢„è§ˆæ„å»ºç»“æœ"
	@echo "  make clean       æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶"
	@echo "  make status      æ£€æŸ¥é¡¹ç›®çŠ¶æ€"
	@echo "  make deps        æ£€æŸ¥ä¾èµ–çŠ¶æ€"
	@echo "  make coverage    ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š"
	@echo ""
	@echo "Docker å‘½ä»¤:"
	@echo "  make docker-build    æ„å»ºDockeré•œåƒ"
	@echo "  make docker-run      è¿è¡ŒDockerå®¹å™¨"
	@echo "  make docker-stop     åœæ­¢Dockerå®¹å™¨"
	@echo "  make docker-logs     æŸ¥çœ‹å®¹å™¨æ—¥å¿—"
	@echo "  make docker-clean    æ¸…ç†Dockerèµ„æº"
	@echo "  make docker-deploy   ä¸€é”®Dockeréƒ¨ç½²"
	@echo "  make compose-up      å¯åŠ¨Docker Compose"
	@echo "  make compose-down    åœæ­¢Docker Compose"
	@echo "  make deploy          ä½¿ç”¨éƒ¨ç½²è„šæœ¬éƒ¨ç½²"
	@echo ""

# å®‰è£…ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
	npm ci

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	npm run dev

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
build:
	@echo "ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
	npm run build
	@echo "âœ… æ„å»ºå®Œæˆ! è¾“å‡ºç›®å½•: dist/"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶..."
	npm run test

# æµ‹è¯•UIç•Œé¢
test-ui:
	@echo "ğŸ§ª å¯åŠ¨æµ‹è¯•UIç•Œé¢..."
	npm run test:ui

# è¿è¡Œæ‰€æœ‰æµ‹è¯• (CIæ¨¡å¼)
test-ci:
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯• (CIæ¨¡å¼)..."
	npm run test:run

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡
coverage:
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	npm run test:coverage
	@echo "ğŸ“ˆ è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ: coverage/index.html"

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	npm run lint

# è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
lint-fix:
	@echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜..."
	npm run lint -- --fix

# é¢„è§ˆæ„å»ºç»“æœ
preview: build
	@echo "ğŸ‘€ é¢„è§ˆæ„å»ºç»“æœ..."
	npm run preview

# å®Œæ•´çš„CIæ£€æŸ¥æµç¨‹
ci-check:
	@echo "ğŸ”„ è¿è¡Œå®Œæ•´CIæ£€æŸ¥æµç¨‹..."
	@echo "1. ä¾èµ–å®‰è£…..."
	npm ci
	@echo "2. ä»£ç æ£€æŸ¥..."
	npm run lint
	@echo "3. è¿è¡Œæµ‹è¯•..."
	npm run test:run
	@echo "4. æ„å»ºéªŒè¯..."
	npm run build
	@echo "âœ… CIæ£€æŸ¥æµç¨‹å®Œæˆ!"

# æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶..."
	rm -rf node_modules/.vite
	rm -rf node_modules/.cache
	rm -rf .eslintcache
	rm -rf coverage
	rm -rf dist
	@echo "âœ… æ¸…ç†å®Œæˆ!"

# å®Œå…¨é‡ç½®é¡¹ç›®
reset: clean
	@echo "ğŸ”„ å®Œå…¨é‡ç½®é¡¹ç›®..."
	rm -rf node_modules
	rm -rf package-lock.json
	npm install
	@echo "âœ… é¡¹ç›®é‡ç½®å®Œæˆ!"

# æ£€æŸ¥é¡¹ç›®çŠ¶æ€
status:
	@echo "ğŸ“Š é¡¹ç›®çŠ¶æ€æ£€æŸ¥:"
	@echo ""
	@echo "Nodeç‰ˆæœ¬:"
	@node --version 2>/dev/null || echo "âŒ Node.jsæœªå®‰è£…"
	@echo ""
	@echo "npmç‰ˆæœ¬:"
	@npm --version 2>/dev/null || echo "âŒ npmæœªå®‰è£…"
	@echo ""
	@echo "é¡¹ç›®ä¾èµ–çŠ¶æ€:"
	@npm ls --depth=0 2>/dev/null || echo "âŒ ä¾èµ–æœ‰é—®é¢˜ï¼Œè¿è¡Œ 'make install'"
	@echo ""
	@echo "GitçŠ¶æ€:"
	@git status --porcelain 2>/dev/null || echo "âŒ ä¸åœ¨Gitä»“åº“ä¸­"

# æ£€æŸ¥ä¾èµ–çŠ¶æ€
deps:
	@echo "ğŸ“¦ ä¾èµ–çŠ¶æ€æ£€æŸ¥:"
	@echo ""
	@echo "è¿‡æ—¶çš„ä¾èµ–:"
	@npm outdated 2>/dev/null || echo "âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„"
	@echo ""
	@echo "å®‰å…¨å®¡è®¡:"
	@npm audit --audit-level=moderate 2>/dev/null || echo "âš ï¸  å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¿è¡Œ 'npm audit fix'"

# æ€§èƒ½æ£€æŸ¥
perf:
	@echo "âš¡ æ€§èƒ½æ£€æŸ¥:"
	@echo ""
	@echo "æ„å»ºå¤§å°åˆ†æ:"
	@if [ ! -d "dist" ]; then \
		echo "ğŸ”¨ æ­£åœ¨æ„å»ºé¡¹ç›®..."; \
		make build >/dev/null 2>&1; \
	fi
	@echo "ğŸ“ dist/ ç›®å½•å¤§å°:"
	@du -sh dist/ 2>/dev/null || echo "âŒ æ„å»ºå¤±è´¥æˆ–ç›®å½•ä¸å­˜åœ¨"
	@echo ""
	@echo "ğŸ“„ ä¸»è¦æ–‡ä»¶å¤§å°:"
	@if [ -d "dist/assets" ]; then \
		ls -lah dist/assets/ | head -10; \
	else \
		echo "âŒ assetsç›®å½•ä¸å­˜åœ¨"; \
	fi

# éƒ¨ç½²å‡†å¤‡æ£€æŸ¥
deploy-check:
	@echo "ğŸš€ éƒ¨ç½²å‡†å¤‡æ£€æŸ¥:"
	@echo ""
	@echo "1. GitçŠ¶æ€æ£€æŸ¥..."
	@git status --porcelain 2>/dev/null || echo "âŒ GitçŠ¶æ€æœ‰é—®é¢˜"
	@echo ""
	@echo "2. è¿è¡ŒCIæ£€æŸ¥..."
	@make ci-check 2>/dev/null || echo "âš ï¸ CIæ£€æŸ¥å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"
	@echo ""
	@echo "3. æ„å»ºå¤§å°æ£€æŸ¥..."
	@make perf 2>/dev/null || echo "âš ï¸ æ€§èƒ½æ£€æŸ¥å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰"
	@echo ""
	@echo "âœ… éƒ¨ç½²å‡†å¤‡æ£€æŸ¥å®Œæˆ!"

# å¼€å‘ç¯å¢ƒè®¾ç½® (æ–°é¡¹ç›®åˆå§‹åŒ–)
setup:
	@echo "ğŸ› ï¸  è®¾ç½®å¼€å‘ç¯å¢ƒ..."
	@echo "1. å®‰è£…ä¾èµ–..."
	@make install
	@echo "2. è¿è¡Œåˆå§‹æ£€æŸ¥..."
	@make status
	@echo "3. è¿è¡Œæµ‹è¯•éªŒè¯..."
	@make test-ci
	@echo "4. æ„å»ºéªŒè¯..."
	@make build
	@echo ""
	@echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ!"
	@echo "ğŸ’¡ ç°åœ¨å¯ä»¥è¿è¡Œ 'make dev' å¯åŠ¨å¼€å‘æœåŠ¡å™¨"

# Gitç›¸å…³æ“ä½œ
git-clean:
	@echo "ğŸ§¹ æ¸…ç†Gitç¼“å­˜..."
	git rm -r --cached .
	git add .
	@echo "âœ… Gitç¼“å­˜æ¸…ç†å®Œæˆ"

# æ›´æ–°ä¾èµ– (å°å¿ƒä½¿ç”¨)
update-deps:
	@echo "ğŸ“¦ æ›´æ–°ä¾èµ– (ä¿å®ˆæ›´æ–°)..."
	npm update
	@echo "ğŸ§ª æµ‹è¯•æ›´æ–°åçš„ä¾èµ–..."
	@make test-ci
	@echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ!"

# å¿«é€Ÿä¿®å¤å¸¸è§é—®é¢˜
fix:
	@echo "ğŸ”§ å¿«é€Ÿä¿®å¤å¸¸è§é—®é¢˜..."
	@echo "1. æ¸…ç†ç¼“å­˜..."
	@make clean
	@echo "2. é‡æ–°å®‰è£…ä¾èµ–..."
	npm ci
	@echo "3. ä¿®å¤ä»£ç æ ¼å¼..."
	@make lint-fix
	@echo "4. éªŒè¯ä¿®å¤ç»“æœ..."
	@make test-ci
	@echo "âœ… å¿«é€Ÿä¿®å¤å®Œæˆ!"

# Docker ç›¸å…³å‘½ä»¤
# æ„å»ºDockeré•œåƒ
docker-build:
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	docker build -t online-time:latest .
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ!"

# è¿è¡ŒDockerå®¹å™¨
docker-run:
	@echo "ğŸš€ å¯åŠ¨Dockerå®¹å™¨..."
	docker run -d --name online-time-app -p 80:80 online-time:latest
	@echo "âœ… Dockerå®¹å™¨å¯åŠ¨å®Œæˆ!"
	@echo "ğŸŒ è®¿é—®åœ°å€: http://localhost"

# åœæ­¢Dockerå®¹å™¨
docker-stop:
	@echo "ğŸ›‘ åœæ­¢Dockerå®¹å™¨..."
	docker stop online-time-app || true
	docker rm online-time-app || true
	@echo "âœ… Dockerå®¹å™¨å·²åœæ­¢!"

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-logs:
	@echo "ğŸ“‹ æŸ¥çœ‹å®¹å™¨æ—¥å¿—..."
	docker logs -f online-time-app

# æ¸…ç†Dockerèµ„æº
docker-clean:
	@echo "ğŸ§¹ æ¸…ç†Dockerèµ„æº..."
	docker stop online-time-app || true
	docker rm online-time-app || true
	docker rmi online-time:latest || true
	docker system prune -f
	@echo "âœ… Dockeræ¸…ç†å®Œæˆ!"

# ä¸€é”®Dockeréƒ¨ç½²
docker-deploy: docker-stop docker-build docker-run
	@echo "ğŸ‰ Dockeréƒ¨ç½²å®Œæˆ!"
	@echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€: http://localhost"
	@echo "ğŸ” å¥åº·æ£€æŸ¥: http://localhost/health"

# Docker Compose å¯åŠ¨
compose-up:
	@echo "ğŸ³ å¯åŠ¨Docker ComposeæœåŠ¡..."
	docker-compose up -d
	@echo "âœ… Docker ComposeæœåŠ¡å¯åŠ¨å®Œæˆ!"

# Docker Compose åœæ­¢
compose-down:
	@echo "ğŸ›‘ åœæ­¢Docker ComposeæœåŠ¡..."
	docker-compose down
	@echo "âœ… Docker ComposeæœåŠ¡å·²åœæ­¢!"

# ä½¿ç”¨éƒ¨ç½²è„šæœ¬
deploy:
	@echo "ğŸš€ ä½¿ç”¨éƒ¨ç½²è„šæœ¬è¿›è¡Œéƒ¨ç½²..."
	./deploy.sh

# ç”Ÿäº§æ¨¡å¼çš„Docker Composeï¼ˆåŒ…å«ç›‘æ§ï¼‰
compose-prod:
	@echo "ğŸ³ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ Docker Composeï¼ˆåŒ…å«ç›‘æ§ï¼‰..."
	docker-compose --profile monitoring up -d

# Dockerå¥åº·æ£€æŸ¥
docker-health:
	@echo "ğŸ¥ æ£€æŸ¥Dockerå®¹å™¨å¥åº·çŠ¶æ€..."
	@if docker ps | grep -q online-time-app; then \
		echo "âœ… å®¹å™¨æ­£åœ¨è¿è¡Œ"; \
		curl -f http://localhost/health && echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡" || echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"; \
	else \
		echo "âŒ å®¹å™¨æœªè¿è¡Œ"; \
	fi