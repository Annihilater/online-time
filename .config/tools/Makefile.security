# å®‰å…¨æ“ä½œMakefile
# æä¾›å®‰å…¨ç›¸å…³çš„è‡ªåŠ¨åŒ–å‘½ä»¤

.PHONY: help audit scan deploy-secure ssl vault waf monitor clean-security

# é»˜è®¤ç›®æ ‡
help:
	@echo "Online Time Security Management"
	@echo "================================"
	@echo ""
	@echo "Available commands:"
	@echo "  make audit          - Run full security audit"
	@echo "  make scan           - Scan for vulnerabilities"
	@echo "  make deploy-secure  - Deploy with security hardening"
	@echo "  make ssl            - Generate SSL certificates"
	@echo "  make vault          - Initialize secret management"
	@echo "  make waf            - Deploy WAF protection"
	@echo "  make monitor        - Start security monitoring"
	@echo "  make test-security  - Run security tests"
	@echo "  make clean-security - Clean security artifacts"
	@echo ""
	@echo "Quick start:"
	@echo "  make deploy-secure  - Full secure deployment"
	@echo ""

# è¿è¡Œå®Œæ•´å®‰å…¨å®¡è®¡
audit:
	@echo "ğŸ” Running security audit..."
	@chmod +x ./security/security-audit.sh
	@./security/security-audit.sh
	@echo "âœ… Audit complete. Check ./security/reports/ for results"

# æ‰«ææ¼æ´
scan:
	@echo "ğŸ” Scanning for vulnerabilities..."
	@echo "â†’ Scanning Docker images..."
	@docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
		aquasec/trivy image online-time:secure || true
	@echo "â†’ Scanning dependencies..."
	@npm audit --production || true
	@echo "â†’ Scanning source code..."
	@docker run --rm -v $(PWD):/src \
		securego/gosec -fmt json -out /src/security/reports/gosec-report.json /src/... 2>/dev/null || true
	@echo "âœ… Vulnerability scan complete"

# å®‰å…¨éƒ¨ç½²
deploy-secure: ssl
	@echo "ğŸš€ Deploying with security hardening..."
	@echo "â†’ Building secure image..."
	@docker build -f security/Dockerfile.secure -t online-time:secure .
	@echo "â†’ Starting secure containers..."
	@docker-compose -f security/docker-compose.secure.yml up -d
	@echo "â†’ Waiting for services to start..."
	@sleep 10
	@echo "â†’ Running health checks..."
	@docker-compose -f security/docker-compose.secure.yml ps
	@echo "âœ… Secure deployment complete"
	@echo "Access the application at: https://localhost"

# ç”ŸæˆSSLè¯ä¹¦
ssl:
	@echo "ğŸ” Generating SSL certificates..."
	@chmod +x ./security/ssl/generate-ssl.sh
	@./security/ssl/generate-ssl.sh localhost dev
	@echo "âœ… SSL certificates generated"

# ç”Ÿäº§SSLè¯ä¹¦
ssl-prod:
	@echo "ğŸ” Setting up production SSL..."
	@read -p "Enter your domain: " domain; \
	./security/ssl/generate-ssl.sh $$domain production
	@echo "âœ… Production SSL configured"

# åˆå§‹åŒ–Vault
vault:
	@echo "ğŸ—ï¸ Initializing secret management..."
	@docker-compose -f security/docker-compose.secure.yml --profile secrets up -d vault
	@sleep 5
	@chmod +x ./security/vault/init-vault.sh
	@./security/vault/init-vault.sh
	@echo "âœ… Vault initialized"

# éƒ¨ç½²WAF
waf:
	@echo "ğŸ›¡ï¸ Deploying Web Application Firewall..."
	@docker-compose -f security/docker-compose.secure.yml up -d waf
	@echo "â†’ WAF is running on port 80/443"
	@echo "âœ… WAF deployed"

# å¯åŠ¨å®‰å…¨ç›‘æ§
monitor:
	@echo "ğŸ“Š Starting security monitoring..."
	@docker-compose -f security/docker-compose.secure.yml --profile runtime-security up -d
	@echo "â†’ Falco runtime security: Active"
	@echo "â†’ Prometheus metrics: http://localhost:9090"
	@echo "â†’ Grafana dashboards: http://localhost:3000"
	@echo "âœ… Security monitoring active"

# è¿è¡Œå®‰å…¨æµ‹è¯•
test-security:
	@echo "ğŸ§ª Running security tests..."
	@echo "â†’ Testing SSL configuration..."
	@openssl s_client -connect localhost:443 -tls1_2 2>/dev/null | grep "Cipher" || echo "SSL test needs HTTPS enabled"
	@echo "â†’ Testing security headers..."
	@curl -I -s https://localhost | grep -E "X-Frame-Options|X-Content-Type|Strict-Transport" || echo "Headers test needs HTTPS enabled"
	@echo "â†’ Testing WAF..."
	@curl -s "http://localhost/?test=<script>alert(1)</script>" | grep -q "403" && echo "âœ“ XSS blocked" || echo "âœ— XSS not blocked"
	@curl -s "http://localhost/?id=1' OR '1'='1" | grep -q "403" && echo "âœ“ SQLi blocked" || echo "âœ— SQLi not blocked"
	@echo "âœ… Security tests complete"

# åº”æ€¥å“åº”
incident-response:
	@echo "ğŸš¨ Initiating incident response..."
	@echo "â†’ Capturing current state..."
	@docker-compose -f security/docker-compose.secure.yml logs > ./security/reports/incident-$(shell date +%Y%m%d-%H%M%S).log
	@echo "â†’ Listing running containers..."
	@docker ps -a
	@echo "â†’ Checking for suspicious processes..."
	@docker-compose -f security/docker-compose.secure.yml exec online-time-app ps aux || true
	@echo "â†’ Backing up data..."
	@tar -czf ./security/reports/backup-$(shell date +%Y%m%d-%H%M%S).tar.gz ./data/
	@echo "âœ… Incident data collected"

# æ›´æ–°å®‰å…¨ç»„ä»¶
update-security:
	@echo "ğŸ”„ Updating security components..."
	@echo "â†’ Updating WAF rules..."
	@docker pull owasp/modsecurity-crs:nginx-alpine
	@echo "â†’ Updating vulnerability scanner..."
	@docker pull aquasec/trivy:latest
	@echo "â†’ Updating npm packages..."
	@npm audit fix --force || true
	@echo "âœ… Security components updated"

# ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
report:
	@echo "ğŸ“‹ Generating security report..."
	@mkdir -p ./security/reports
	@echo "# Security Report - $(shell date +%Y-%m-%d)" > ./security/reports/report-$(shell date +%Y%m%d).md
	@echo "" >> ./security/reports/report-$(shell date +%Y%m%d).md
	@echo "## Container Security" >> ./security/reports/report-$(shell date +%Y%m%d).md
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" >> ./security/reports/report-$(shell date +%Y%m%d).md
	@echo "" >> ./security/reports/report-$(shell date +%Y%m%d).md
	@echo "## Recent Security Events" >> ./security/reports/report-$(shell date +%Y%m%d).md
	@tail -n 20 ./logs/waf/access.log 2>/dev/null >> ./security/reports/report-$(shell date +%Y%m%d).md || echo "No WAF logs available" >> ./security/reports/report-$(shell date +%Y%m%d).md
	@echo "âœ… Report generated: ./security/reports/report-$(shell date +%Y%m%d).md"

# å¤‡ä»½å®‰å…¨é…ç½®
backup-security:
	@echo "ğŸ’¾ Backing up security configuration..."
	@tar -czf ./security/backups/security-backup-$(shell date +%Y%m%d-%H%M%S).tar.gz \
		./security/*.conf \
		./security/*.yml \
		./security/vault/.vault-token \
		./security/ssl/certs/ \
		./security/ssl/private/ 2>/dev/null || true
	@echo "âœ… Security backup complete"

# æ¸…ç†å®‰å…¨ç»„ä»¶
clean-security:
	@echo "ğŸ§¹ Cleaning security artifacts..."
	@docker-compose -f security/docker-compose.secure.yml down -v
	@rm -rf ./security/reports/*.json ./security/reports/*.txt
	@rm -rf ./security/scan-results/
	@rm -rf ./logs/waf/ ./logs/falco/ ./logs/suricata/
	@echo "âœ… Security artifacts cleaned"

# åœæ­¢æ‰€æœ‰å®‰å…¨æœåŠ¡
stop-security:
	@echo "â¹ï¸ Stopping security services..."
	@docker-compose -f security/docker-compose.secure.yml down
	@echo "âœ… Security services stopped"

# æŸ¥çœ‹å®‰å…¨æ—¥å¿—
logs-security:
	@echo "ğŸ“œ Security logs (last 50 lines):"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@docker-compose -f security/docker-compose.secure.yml logs --tail=50

# æ£€æŸ¥å®‰å…¨çŠ¶æ€
status-security:
	@echo "ğŸ“Š Security Status"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "Container Status:"
	@docker-compose -f security/docker-compose.secure.yml ps
	@echo ""
	@echo "Security Checks:"
	@[ -f ./security/ssl/certs/localhost.crt ] && echo "âœ… SSL Certificate: Present" || echo "âŒ SSL Certificate: Missing"
	@docker ps | grep -q waf && echo "âœ… WAF: Running" || echo "âŒ WAF: Not running"
	@docker ps | grep -q vault && echo "âœ… Vault: Running" || echo "âŒ Vault: Not running"
	@docker ps | grep -q falco && echo "âœ… Runtime Security: Active" || echo "âš ï¸ Runtime Security: Inactive"
	@echo ""
	@echo "Last Audit:"
	@ls -lt ./security/reports/security-audit-*.md 2>/dev/null | head -1 || echo "No audit reports found"

# å¿«é€Ÿå®‰å…¨æ£€æŸ¥
quick-check:
	@echo "âš¡ Quick Security Check"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "â†’ Checking for exposed secrets..."
	@! grep -r "password\|secret\|token\|key" --include="*.env" . 2>/dev/null || echo "âš ï¸ Potential secrets exposed!"
	@echo "â†’ Checking Docker security..."
	@docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
	@echo "â†’ Checking open ports..."
	@netstat -tuln | grep LISTEN || ss -tuln | grep LISTEN || echo "Port check requires admin privileges"
	@echo "âœ… Quick check complete"

# ä¸€é”®éƒ¨ç½²ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
dev-secure:
	@echo "ğŸš€ Deploying secure development environment..."
	@make ssl
	@make deploy-secure
	@make monitor
	@make status-security
	@echo "âœ… Secure development environment ready!"
	@echo "Access: https://localhost:8080"

# ä¸€é”®éƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
prod-secure:
	@echo "ğŸš€ Deploying secure production environment..."
	@make ssl-prod
	@make vault
	@make waf
	@make deploy-secure
	@make monitor
	@make audit
	@echo "âœ… Secure production environment ready!"

.SILENT: help status-security