# HAProxy负载均衡配置
global
    daemon
    maxconn 4096
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    
    # SSL配置(可选)
    # ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
    # ssl-default-bind-options no-sslv3

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor
    option redispatch
    retries 3
    maxconn 2000
    
    # 错误页面
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# 统计页面
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-node
    stats show-legends
    stats admin if TRUE
    # stats auth admin:admin123  # 可选：密码保护

# 主前端
frontend online_time_frontend
    bind *:80
    
    # HTTP安全头
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    
    # 健康检查端点
    acl health_check path_beg /health
    use_backend health_backend if health_check
    
    # 默认后端
    default_backend online_time_backend
    
    # 访问日志
    capture request header Host len 64
    capture request header User-Agent len 128
    capture response header Content-Type len 32

# 应用后端
backend online_time_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    # 服务器实例
    server app1 online-time-app-1:80 check inter 30s fall 3 rise 2 weight 100
    server app2 online-time-app-2:80 check inter 30s fall 3 rise 2 weight 100
    
    # 备用服务器(可选)
    # server backup-app backup-server:80 check backup
    
    # Gzip压缩
    compression algo gzip
    compression type text/html text/plain text/css text/xml text/javascript application/javascript application/json
    
    # 缓存控制
    http-response set-header Cache-Control "public, max-age=3600" if { path_end .js .css .png .jpg .jpeg .gif .ico .svg .woff .woff2 }
    
    # 连接池优化
    option prefer-last-server
    option http-keep-alive

# 健康检查后端
backend health_backend
    http-request return status 200 content-type text/plain string "HAProxy Health Check OK\n"