# OWASP ModSecurity核心规则集(CRS)配置
# 版本: 3.3.4

# 偏执级别(1-4, 越高越严格)
SecAction \
  "id:900000,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.paranoia_level=2"

# 异常评分阈值
SecAction \
  "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=10,\
  setvar:tx.outbound_anomaly_score_threshold=5"

# 采样百分比
SecAction \
  "id:900120,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.sampling_percentage=100"

# 启用的规则引擎
SecAction \
  "id:900130,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.enforce_bodyproc_urlencoded=1"

# 应用标识
SecAction \
  "id:900140,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.app_id=online-time'"

# 允许的HTTP方法
SecAction \
  "id:900150,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS'"

# 允许的请求内容类型
SecAction \
  "id:900160,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_request_content_type=application/x-www-form-urlencoded|multipart/form-data|text/xml|application/xml|application/soap+xml|application/x-amf|application/json|application/octet-stream|text/plain'"

# 允许的HTTP版本
SecAction \
  "id:900170,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0'"

# 限制文件扩展名
SecAction \
  "id:900180,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/'"

# 限制HTTP头
SecAction \
  "id:900190,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.restricted_headers=/proxy/ /lock-token/ /content-range/ /if/'"

# 静态资源扩展名
SecAction \
  "id:900200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.static_extensions=/.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/'"

# DOS保护
SecAction \
  "id:900210,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.dos_burst_time_slice=60',\
  setvar:'tx.dos_counter_threshold=100',\
  setvar:'tx.dos_block_timeout=600'"

# 地理位置阻止（可选）
# SecAction \
#   "id:900220,\
#   phase:1,\
#   nolog,\
#   pass,\
#   t:none,\
#   setvar:'tx.high_risk_country_codes=CN RU KP IR'"

# 启用CRS规则排除
SecAction \
  "id:900230,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.crs_exclusions_cpanel=0',\
  setvar:'tx.crs_exclusions_drupal=0',\
  setvar:'tx.crs_exclusions_nextcloud=0',\
  setvar:'tx.crs_exclusions_wordpress=0',\
  setvar:'tx.crs_exclusions_xenforo=0'"

# 异常评分
SecAction \
  "id:900240,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.anomaly_score_blocking=on',\
  setvar:'tx.critical_anomaly_score=5',\
  setvar:'tx.error_anomaly_score=4',\
  setvar:'tx.warning_anomaly_score=3',\
  setvar:'tx.notice_anomaly_score=2'"

# 回归测试模式
SecAction \
  "id:900250,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.regression_testing=0'"

# 启用收集器
SecCollectionTimeout 600

# IP信誉数据库（可选）
# SecAction \
#   "id:900260,\
#   phase:1,\
#   nolog,\
#   pass,\
#   t:none,\
#   setvar:'tx.reputation_db_path=/usr/share/modsecurity-crs/ip_reputation.db'"