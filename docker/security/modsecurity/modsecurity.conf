# ModSecurity主配置文件
# 基于OWASP ModSecurity核心规则集

# 启用ModSecurity
SecRuleEngine On

# 请求体处理
SecRequestBodyAccess On
SecRequestBodyLimit 1048576
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# 响应体处理
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# 文件系统配置
SecTmpDir /tmp/
SecDataDir /tmp/

# 审计日志
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/audit.log

# 调试日志
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 3

# 规则处理
SecArgumentSeparator &
SecCookieFormat 0
SecUnicodeMapFile unicode.mapping 20127
SecStatusEngine On

# 性能设置
SecRequestBodyInMemoryLimit 131072
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# 集合超时
SecCollectionTimeout 600

# 默认动作
SecDefaultAction "phase:1,log,auditlog,pass"

# 包含OWASP CRS规则
Include /usr/local/owasp-modsecurity-crs/crs-setup.conf
Include /usr/local/owasp-modsecurity-crs/rules/*.conf

# 自定义规则
# 阻止常见的扫描工具
SecRule REQUEST_HEADERS:User-Agent "@rx (nikto|sqlmap|havij|acunetix|netsparker|nmap)" \
    "id:1000,\
    phase:1,\
    block,\
    msg:'Malicious scanner detected',\
    logdata:'User-Agent: %{REQUEST_HEADERS.User-Agent}',\
    severity:'CRITICAL',\
    tag:'scanner',\
    tag:'attack-scanner'"

# 限制请求速率
SecRule IP:REQUEST_COUNTER "@gt 100" \
    "id:1001,\
    phase:1,\
    block,\
    msg:'Request rate limit exceeded',\
    logdata:'Requests: %{IP.REQUEST_COUNTER}',\
    severity:'WARNING',\
    tag:'dos',\
    tag:'rate-limit'"

SecAction \
    "id:1002,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.request_counter=+1,\
    expirevar:ip.request_counter=60"

# 防止路径遍历
SecRule REQUEST_URI "@rx (\.\./|\.\.\\|%2e%2e%2f|%252e%252e%252f)" \
    "id:1003,\
    phase:1,\
    block,\
    msg:'Path traversal attempt',\
    logdata:'URI: %{REQUEST_URI}',\
    severity:'CRITICAL',\
    tag:'lfi',\
    tag:'attack-lfi'"

# 阻止SQL注入尝试
SecRule ARGS "@detectSQLi" \
    "id:1004,\
    phase:2,\
    block,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    severity:'CRITICAL',\
    tag:'sqli',\
    tag:'attack-sqli'"

# 阻止XSS攻击
SecRule ARGS|REQUEST_HEADERS "@detectXSS" \
    "id:1005,\
    phase:2,\
    block,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    severity:'CRITICAL',\
    tag:'xss',\
    tag:'attack-xss'"

# 防止命令注入
SecRule ARGS "@rx (;|\||`|>|<|\$\(|\${)" \
    "id:1006,\
    phase:2,\
    block,\
    msg:'OS Command Injection',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    severity:'CRITICAL',\
    tag:'rce',\
    tag:'attack-rce'"

# 限制文件上传类型
SecRule FILES_TMPNAMES "@rx \.(php|phtml|php3|php4|php5|phps|phar|asp|aspx|jsp|asa|cer|cdx|cgi|pl|py|rb|sh|exe|dll|com|bat|cmd|vbs|js)$" \
    "id:1007,\
    phase:2,\
    block,\
    msg:'Dangerous file upload attempt',\
    logdata:'Filename: %{MATCHED_VAR}',\
    severity:'CRITICAL',\
    tag:'upload',\
    tag:'attack-upload'"